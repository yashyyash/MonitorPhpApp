name: PHP App Monitoring

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version

      - name: Configure AWS Credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set default.region us-east-1

      - name: Setup Log Directory
        run: |
          # Create log directory in the workspace
          mkdir -p "$GITHUB_WORKSPACE/logs"
          # Create the log file
          touch "$GITHUB_WORKSPACE/logs/phpappmonitor.log"
          # Set permissions
          chmod 666 "$GITHUB_WORKSPACE/logs/phpappmonitor.log"
          # Export log path for the monitoring script
          echo "MONITOR_LOG_PATH=$GITHUB_WORKSPACE/logs/phpappmonitor.log" >> $GITHUB_ENV

      - name: Run PHP App Monitoring Script
        env:
          LOG_FILE: ${{ env.MONITOR_LOG_PATH }}
        run: |
          # Debug information
          echo "Current directory: $(pwd)"
          echo "Log file location: $LOG_FILE"
          
          # Ensure script exists
          if [ ! -f "phpappmonitor.sh" ]; then
            echo "Error: phpappmonitor.sh not found"
            ls -la
            exit 1
          fi
          
          # Make script executable
          chmod +x phpappmonitor.sh
          
          # Run script with explicit log file path
          ./phpappmonitor.sh "$LOG_FILE"